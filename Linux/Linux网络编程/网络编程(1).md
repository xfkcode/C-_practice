# 网络编程(1)

## 1. 网络基础概念

【:computer:】IP地址确定网络环境中唯一的一台主机  
             主机上的端口号区分不同的应用程序

- [x] **IP+端口确定一台主机上的一个服务** 

### 1.1 协议

概念：协议指事先约定好，大家共同遵守的一组规则，如交通信号灯  
从应用程序的角度看，协议可以理解为数据传输和数据解释的规则；  
可以简单的理解为各个主机之间进行通信所使用的共同语言

【:open_file_folder:】文件传输协议（**ftp协议** 初级版本）  
		     A机器 $\rightarrow$ B机器  
			 1.文件名 2.文件大小 3.文件内容  
			 B机器 $\rightarrow$ A机器  >>> OK

金典协议

TCP协议，传输控制协议，是一种面向连接的、可靠的、基于字节流的传输层通信协议  
UDP协议，用户数据报协议是，OSI参考模型中一种无线连接的传输层协议，提供面向事务的简单不可靠信息传送服务  
HTTP协议，超文本传输协议，是互联网上应用最为广泛的一种网络协议  
FTP协议，文件传输协议  
IP协议，因特网互联协议  
ICMP协议，Internet控制报文协议，是TCP/IP协议的族的一个子协议，用于在IP主机、路由器之间传递控制消息  
IGMP协议，Internet组管理协议，是因特网协议家族中的一个组播协议。该协议运行在主机和组播路由器之间  
ARP协议，正向地址解析协议，通过已知的IP，寻找对应主机的MAC地址  
RARP协议，反向地址转换协议，通过MAC地址确定IP地址

### 1.2 分层模型

**OSI**（Open System Interconnection），开放式系统互联  
国际标准化组织（ISO）制定了OSI模型，该模型定义了不同计算机互联的标准，是设计和描述计算机网络通信的基本框架

【:boxing_glove:】**OSI 7层模型**   
            物数网传会表应

- 物理层---双绞线，光纤，将模拟信号转换为数字信号
- 数据链路层---数据校验，定义了网络传输的基本单位【帧】（ARP协议、RARP协议）
- 网络层---定义网络，两台机器之间传输的路径选择点到点的传输（IP协议、ICMP协议、IGMP协议）
- 传输层---传输数据，端到端的传输（TCP协议，UDP协议）
- 会话层---通过传输层建立数据传输的通道，建立会话保持会话
- 表示层---编解码，翻译工作
- 应用层---为客户提供各种应用服务，email服务，ftp服务，ssh服务（http协议）

【:ticket:】**TCP/IP 4层模型** 

- 网络接口层>>>【物+数】
- 网络层
- 传输层
- 应用层>>>【会+表+应】

**数据通信过程：**   
在发送方是数据层层打包过程，在接收方是层层解包过程  
TCP/IP 模型层层打包/解包

### 1.3 网络应用程序设计模式

- C/S模式  
  传统网络应用设计模式，客户机（client）/服务器（server）模式  
  需要在通讯两端各自部署客户机和服务器来完成数据通信
- B/S模式  
  浏览器（browser）/服务器（server）模式  
  只需要在一端部署服务器，而另外一端使用每台PC都默认配置的浏览器即可完成数据的传输

### 1.4 以太网帧格式

以太网帧格式是包装在网络接口层（数据链路层）的协议

【目的地址（MAC地址）6Byte】+【源地址（MAC地址）6Byte】+ 【类型2Byte】+【数据46~1500Byte】+【CRC4Byte】

- 类型 0800 ：【IP数据报46~1500Byte】
- 类型 0806 ：【ARP请求/应答28Byte】+【PAD18Byte】
- 类型 0835 ：【RARP请求/应答28Byte】+【PAD18Byte】

【:printer:】ARP协议：地址解析协议，通过目的IP地址获取其MAC地址  
             RARP协议：逆地址解析协议，MAC地址 $\rightarrow$ IP地址  
			 TCP协议：面向连接的，安全的，可靠的数据流传输协议  
             UDP协议：面向无连接的，不安全的，不可靠的数据报传输  

## 2. SOCKET编程

传统的进程间通信借助内核提供的IPC机制进行，但是只能限于本机通信，若要跨机通信，就必须使用网络通信  
本质上借助内核-内核提供了socket伪文件的机制实现通信，实际上是使用文件描述符，这就需要用到内核提供给用户的 socket API 库函数

### 2.1 socket编程预备知识

网络字节序  
大端和小端的概念

- 大端：低位地址存放高位数据，高位地址存放低位数据
- 小端：低位地址存放低位数据，高位地址存放高位数据

```C
#include <stdio.h>
#include <stdlib.h>

union{
    short s;
    char c[sizeof(short)];
} un2;
union{
    int s;
    char c[sizeof(int)];
} un4;

int main()
{
    printf("[%d][%d][%d]\n", sizeof(short), sizeof(int), sizeof(long int));
    //测试short类型
    un2.s = 0x0102;
    printf("%d,%d,%d\n", un2.c[0], un2.c[1], un2.s);
    
    //测试int类型
    un4.s = 0x01020304;
    printf("%d,%d,%d,%d,%d\n", un4.c[0], un4.c[1], un4.c[2], un4.c[3], un4.s);
    return 0;
}

>>>>执行结果
[xfk@centos SOCKET]$ ./endian
[2][4][8]
2,1,258
4,3,2,1,16909060
```

【:triangular_flag_on_post:】大小端转换函数  
			 网络传输用的是大端，如果主机用的是小端，则需要进行大小端转换

```C
#include <arpa/inet.h>
uint32_t htonl(unit32_t hostlong);
uint16_t htons(unit16_t hostshort);
uint32_t ntohl(unit32_t netlong);
uint16_t ntohs(unit16_t netshort);
```

  h>>>主机host，n>>>网络network，s>>>short，l>>>long

【:atm:】IP地址转换函数

```C
#include <arpa/inet.h>
int inet_pton(int af, const char *src, void *dst);
const char *inet_ntop(int af, const void *src, char *dst, socklen_t size);
```

  p>>>点分十进制的字符串形式，n>>>网络network

- 函数1说明：将字符串形式的点分十进制IP转换为大端模式的网络IP
- 参数说明：
  - `af` AF_INET / AF_INET6
  - `src` 字符串形式的点分十进制IP地址
  - `dst` 存放转换后的变量的地址

:recycle:转换原则：`192.168.232.145`   
                    转十六进制：192>>>0xC0，168>>>0xA8，232>>>0xE8，145>>>0x91  
                     `0x91E8A8C0` 

- 函数2说明：将大端模式的网络IP转换为字符串形式的点分十进制IP
- 参数说明：
  - `af` AF_INET / AF_INET6
  - `src` 大端模式的网络IP
  - `dst` 存放转换后的变量的地址（一般为字符串数组）
  - `size` dst 的长度（16）
- 返回值：
  - 成功：返回指向 dst 的指针
  - 失败：返回NULL，并设置 `errno` 

:recycle:转换原则：`0x010AA8C0`   
                    转十进制：0x01>>>1，0x0A>>>10，0xA8>>>168，0xC0>>>192  
                    `192.168.10.1` 